<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta content="en-au" http-equiv="Content-Language" />
		<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
		<link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Blog Feed" />
		<link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Blog Feed" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
		<title>Combining NuGet with Team Foundation Build</title>
		<link rel="stylesheet" type="text/css" href="/css/mystyle.css" />
		<link rel="shortcut icon" href="/img/favicon.ico" />
		<script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.0.0.js"></script>
		<link href="/css/shCore.css" rel="stylesheet" type="text/css" />
		<link href="/css/shThemeRDark.css" rel="stylesheet" type="text/css" />
		<script src="/js/shCore.js" type="text/javascript"></script>
		<script src="/js/shAutoloader.js" type="text/javascript"></script>
		<script type="text/javascript">
			$(function() {
				SyntaxHighlighter.autoloader(
					"js jscript javascript              /js/shBrushJScript.js",
					"cs csharp c-sharp                  /js/shBrushCSharp.js",
					"xml xhtml xslt html xhtml          /js/shBrushXml.js",
					"sql                                /js/shBrushSql.js",
					"ps powershell shell                /js/shBrushPowerShell.js"
				);
				SyntaxHighlighter.all();
			});
		</script>
	</head>
	<body>
		<div id="header">
			<div id="headerContent">
				<img id="logo" src="/img/dan.png" alt="Dan Pincas" />
				<a href="/"><h3>a Pincas draws near! Command?</h3></a>
				<nav id="headerNav">
					<ul>
						<li><a href="/"><img src="/img/blog.png" /><span>blog</span></a></li>
						<li><a href="/about.html"><img src="/img/about.png" /><span>about</span></a></li>
						<li><a href="/projects.html"><img src="/img/projects.png" /><span>projects</span></a></li>
						<li><a href="https://twitter.com/pandincus"><img src="/img/twitter.png" /><span>twitter</span></a></li>
						<li><a href="http://stackoverflow.com/users/2273/pandincus"><img src="/img/stackoverflow.png" /><span>stackoverflow</span></a></li>
						<li><a href="/rss.xml"><img src="/img/rss.png" /><span>rss</span></a></li>
					</ul>
				</nav>
			</div>
		</div>
		<div id="container">
			<div id="content">
				<div class="entry-container">
	<div class='entry'>
		<h1> Combining NuGet with Team Foundation Build </h1>
		<span class="postdate">
			
				<li><a href="/tag/.net">.net</a></li>
			
				<li><a href="/tag/deploying">deploying</a></li>
			
				<li><a href="/tag/nuget">nuget</a></li>
			
				<li><a href="/tag/tfs">tfs</a></li>
			
				<li><a href="/tag/continuous integration">continuous integration</a></li>
			
				<li><a href="/tag/source control">source control</a></li>
			
		</span>
		<p><strong>Update: This post refers to NuGet 1.2. Although the techniques described here are still valid, once NuGet 1.4 comes out, Dan Turner’s fork will no longer be necessary. Thus, please keep the date of this post in mind!</strong></p>
<p>I’ve been experimenting with setting up a build server for our dev team at work. I didn’t run into any challenges until I configured the build agent.</p>
<p>When I initiated a test build for one of our apps, it failed with a bunch of these:</p>
<blockquote>
<p>Could not resolve this reference. Could not locate the assembly “<assembly>”. Check to make sure the assembly exists on disk. If this reference is required by your code, you may get compilation errors.</p>
</blockquote>
<p>D’oh! Of course, <strong>my build agent had no idea where to find my project’s external references</strong>.</p>
<p>This is a common scenario, and there are all kinds of suggested solutions. For referencing your own projects, the Microsoft Patterns &amp; Practices group <a href="http://tfsguide.codeplex.com/wikipage?title=Practices%20at%20a%20Glance:%20%20%20Build">suggests the following</a>:</p>
<blockquote>
<p>…you need to get the source or assemblies from that project into the workspace on your build server…edit your TFSBuild.proj file to add the assembly or the solution reference and override the BeforeGet event to get assemblies or sources from each of the team projects on which you have a dependency.</p>
</blockquote>
<p>The above solution, however, would always <strong>get the latest version</strong> of your referenced projects. What if you wanted a specific version? Microsoft Patterns &amp; Practices suggests <a href="http://tfsguide.codeplex.com/wikipage?title=Chapter%206%20-%20Managing%20Source%20Control%20Dependencies%20in%20Visual%20Studio%20Team%20System&amp;ProjectName=tfsguide">branching the external team project into your team project</a>.</p>
<p>Although branching and utilizing source control makes sense, putting third-party, compiled assemblies into source control puts a bad taste in my mouth. Surely there must be some other way? A search on StackOverflow reveals a lot of people <a href="http://stackoverflow.com/questions/3242663/team-foundation-server-2010-build-with-external-library">asking</a> about <a href="http://stackoverflow.com/questions/1823594/team-foundation-build-resolving-cross-solution-project-references">how</a> to do <a href="http://stackoverflow.com/questions/1207728/team-foundation-server-add-rereference-to-existing-dll-to-a-new-class-library-p">this</a>, and a lot of different approaches to solving it.</p>
<h2>Enter NuGet</h2>
<p><a href="http://nuget.codeplex.com/">NuGet</a> is a relatively new, open-source package management solution for .NET developers that has been getting a lot of support from Microsoft. (The idea is to make the process of adding external, third-party libraries easier — here’s <a href="http://haacked.com/archive/2010/10/06/introducing-nupack-package-manager.aspx">an example</a>.)</p>
<p>Our team has been slowly adopting the use of NuGet for all of our third party libraries. Now that we have a build server up and running, I was wondering: <strong>Can we leverage NuGet to resolve our dependencies for us?</strong></p>
<p>Daniel Auger <em>briefly</em> discusses using NuGet for .NET Dependency Management, but <a href="http://mynerditorium.blogspot.com/2011/02/net-dependency-management-in-pre-nuget.html">he dismisses it entirely</a> in his blog:</p>
<blockquote>
<p><strong>Nuget is not the final answer for teams using TFS</strong></p>
<p>I’ve been following the Nuget dev list closely, and Nuget is considered to be a development time dependency resolver only, not a build time resolver. This means that if you use TFS to track your Nuget package folders, you could still run into dll versioning issues.</p>
</blockquote>
<p><s>I admit I don’t understand Daniel’s point here. NuGet should be able to track versions for us, and the versioning should work just as well on our build server as on our development machines.</s></p>
<p><strong>Edit:</strong> I asked Daniel about this and, after further discussion, he believes NuGet can be used as a build time resolver as well.</p>
<p>To understand how we can use NuGet, let’s look at what happens when we add a package to a typical .NET project:</p>
<pre><code>MySolution\
  MyProject\
    bin\
    obj\
    Properties\
    MyProject.csproj
    Program.cs
  MySolution.sln
</code></pre>

<p>Now let’s add, for example, Ninject v 2.2.1.0:</p>
<pre><code>MySolution\
  MyProject\
    bin\
    obj\
    Properties\
    MyProject.csproj
    Program.cs
    packages.config
  packages\
    Ninject.2.2.1.0\
      lib\
        (the assemblies go here)
      Ninject.2.2.1.0.nupkg
    repositories.config
  MySolution.sln
</code></pre>

<ul>
<li>The <strong>packages.config</strong> file exists once per project, and it lists any NuGet packages that are in use for that project (it also includes the version #):</li>
</ul>
<pre class="brush: xml;">
<packages>
  <package id="Ninject" version="2.2.1.0" />
</packages>
</pre>
<ul>
<li>The <strong>repositories.config</strong> file just points to each <strong>packages.config</strong> file for the solution.</li>
<li>The *<em>packages*</em> folder is where all downloaded assemblies for any projects in the solution are stored.</li>
<li>The <strong>MyProject.csproj</strong> file is changed to add the actual assembly to your project:</li>
</ul>
<pre class="brush: xml;">
<Reference Include="Ninject">
    <HintPath>..\packages\Ninject.2.2.1.0\lib\.NetFramework 4.0\Ninject.dll</HintPath>
</Reference>
</pre>
<p>We can leverage the <a href="http://nuget.codeplex.com/releases/58939/download/222685">command line NuGet.exe program</a> to download NuGet packages from the online repository to the local <strong>packages\</strong> folder, just by pointing it at our <strong>packages.config</strong> file! Here’s the plan:</p>
<ol>
<li>Each developer would install <strong>NuGet.exe</strong> on their system path.</li>
<li>We’d download <strong>NuGet.exe</strong> to the build server and add it to the system <code>PATH</code>.</li>
<li>When developing any project that used NuGet references, we’d add</li>
</ol>
<pre class="brush: ps">
nuget install “$(ProjectDir)packages.config” -o “$(SolutionDir)packages”
</pre>
<p>to the project’s Pre-build event. <em>(This will tell NuGet to install any packages listed in the project’s packages.config, and download their files to the ‘packages’ folder under the solution folder.)</em></p>
<p>Almost perfect. But what if we needed references that weren’t on NuGet? Perhaps we had to reference some obscure vendor .dll that had no place in a public gallery. To handle this case, we had to create a local NuGet repository and agree to store all internal .dlls there.</p>
<p>But wait! The <code>nuget install</code> command only lets us specify <strong>one</strong> source for our libraries; meaning we can either specify the public NuGet repository or our local repository, but not both.</p>
<p>Fortunately, in <a href="http://nuget.codeplex.com/discussions/249628">a discussion on CodePlex</a>, <a href="http://www.codeplex.com/site/users/view/dant199">Dan Turner</a> decided to be amazing and <a href="http://nuget.codeplex.com/SourceControl/network/Forks/dant199/NuGetMultipleSources">create a fork of NuGet.exe that allows you to specify multiple sources</a>. This makes our entire Pre-build event:</p>
<pre class="brush: ps">
nuget install “$(ProjectDir)packages.config” -o “$(SolutionDir)packages”
-s “\\asa01\asa_share\Dan\ASA NuGet Repository”;https://go.microsoft.com/fwlink/?LinkID=206669
</pre>
<p>This solution, to me, feels perfect. We’re not storing any assemblies in source control, and our <strong>packages.config</strong> file should handle package versioning for us.</p>
<p>A big thank you to Dan Turner for making those changes to NuGet.exe. <em>(Perhaps it’ll get added to trunk?)</em> Hopefully this article will guide someone else in a similar situation!</p>

	</div>
</div>
<div id="page-navigation"> 
	<div class="left">  </div> 
	<div class="right">  </div> 
	<div class="clear">&nbsp;</div>
</div> 



<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'NAME'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

			</div>
		</div>
		<footer>
			<p>Site built using <a href="http://code52.org/pretzel/">pretzel</a> and hosted using <a href="http://pages.github.com/">github pages</a>. Navigation icons are remixed versions of the <a href="http://dakirby309.deviantart.com/art/Metro-UI-Icon-Set-725-Icons-280724102">Metro UI Icon Set by dAKirby309</a>.</p>
		</footer>
	</body>
</html>